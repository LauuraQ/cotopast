<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä —Å–ø–∏—Å–∫–æ–≤ (Firebase)</title>
    <style>
        @charset "UTF-8";

        /* --- 1. –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ë–ê–ó–û–í–´–ï –ù–ê–°–¢–†–û–ô–ö–ò --- */
        :root {
            --color-light-gray: #A6A6A6;
            --color-gray: #4A4A4A;
            --color-dark-gray: #222222;
            --color-white: #fff;
            --color-background-gray: #F5F5F5;
            --font-sans: "Inter", sans-serif;
            --color-blue-bg: #e3f2fd;
            --color-blue-border: #2196f3;
            --color-blue-text: #0d47a1;
        }

        * {
            padding: 0;
            margin: 0;
            border: 0;
            background: transparent;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            font-family: var(--font-sans);
            color: var(--color-gray);
        }

        input,
        button,
        textarea {
            font-family: inherit;
        }

        button {
            cursor: pointer;
            user-select: none;
        }

        ul li {
            list-style: none;
        }

        /* --- 2. –¢–ò–ü–û–ì–†–ê–§–ò–ö–ê --- */
        h1 {
            font-size: 2.6rem;
            font-weight: bold;
            color: var(--color-gray);
            margin: 30px 0 30px 0;
            text-align: center;
        }

        h2 {
            font-weight: bold;
            color: var(--color-gray);
            margin-top: 70px;
            margin-bottom: 25px;
            text-align: center;
        }

        .intro {
            text-align: center;
            max-width: 800px;
            margin: 0 auto 48px;
        }

        .centration {
            max-width: 800px;
            margin: 0 auto 56px;
            padding: 0 8px;
        }

        /* --- 3. –õ–ï–ô–ê–£–¢ --- */
        .wrapper {
            max-width: 1140px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header_container {
            padding-top: 40px;
            margin-bottom: 50px;
        }

        .footer_container {
            padding-top: 65px;
            margin-top: auto;
            text-align: center;
        }

        .footer_copyright {
            margin-top: 50px;
            margin-bottom: 25px;
            font-size: 1rem;
            color: var(--color-light-gray);
        }

        /* --- 4. –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø --- */
        .controls-container {
            max-width: 800px;
            margin: 48px auto;
            padding: 24px;
            border: 1px solid var(--color-light-gray);
            background-color: var(--color-background-gray);
            border-radius: 8px;
        }

        /* –°—Ç–∞—Ç—É—Å Firebase */
        .firebase-status {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--color-blue-bg);
            border-radius: 8px;
            border: 1px solid var(--color-blue-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width: 600px) {
            .firebase-status {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--color-dark-gray);
        }

        .custom-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-light-gray);
            font-size: 1rem;
            color: var(--color-gray);
            background-color: var(--color-white);
            border-radius: 4px;
        }

        .custom-input:focus {
            border-color: var(--color-gray);
            outline: none;
        }

        /* --- 5. –ö–ê–°–¢–û–ú–ù–´–ï –°–ï–õ–ï–ö–¢–´ --- */
        .custom-dropdown {
            position: relative;
            width: 100%;
        }

        .select-selected {
            background-color: var(--color-white);
            border: 1px solid var(--color-light-gray);
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--color-gray);
        }

        .select-selected.disabled {
            background-color: #eee;
            color: #999;
            cursor: not-allowed;
        }

        .select-arrow {
            border: solid var(--color-gray);
            border-width: 0 2px 2px 0;
            display: inline-block;
            padding: 3px;
            transform: rotate(45deg);
            transition: transform 0.2s ease;
            margin-right: 5px;
            margin-bottom: 2px;
        }

        .select-selected.select-arrow-active .select-arrow {
            transform: rotate(-135deg);
            margin-bottom: -2px;
        }

        .select-items {
            position: absolute;
            background-color: var(--color-white);
            top: 100%;
            left: 0;
            right: 0;
            z-index: 99;
            border: 1px solid var(--color-light-gray);
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .select-hide {
            display: none;
        }

        #category-search-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-bottom: 1px solid var(--color-light-gray);
            outline: none;
            background-color: #FAFAFA;
        }

        .option-item {
            color: var(--color-dark-gray);
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
        }

        .option-item:hover {
            background-color: var(--color-background-gray);
        }

        /* --- 6. –ö–ù–û–ü–ö–ò --- */
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: 2px solid var(--color-gray);
            background-color: transparent;
            color: var(--color-gray);
            font-size: 1rem;
            transition: all 0.3s ease;
            font-weight: 600;
            border-radius: 4px;
        }

        .btn:hover {
            background-color: var(--color-gray);
            color: var(--color-white);
        }

        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* --- 7. –†–ï–ó–£–õ–¨–¢–ê–¢–´ --- */
        .result-container {
            margin-top: 48px;
        }

        #result-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            padding: 12px 15px;
            border-bottom: 1px solid var(--color-background-gray);
        }

        #result-list li::before {
            content: "‚Äî";
            margin-right: 10px;
            color: var(--color-light-gray);
            font-weight: bold;
        }

        .frequency-span {
            color: var(--color-light-gray);
            font-style: italic;
            font-size: 0.9rem;
        }

        /* --- 8. –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê --- */
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--color-white);
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            position: relative;
            animation: slideDown 0.3s ease;
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            line-height: 1;
            cursor: pointer;
            color: var(--color-light-gray);
        }

        .modal-close-btn:hover {
            color: var(--color-dark-gray);
        }

        .info-icon-btn {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 20px;
            height: 20px;
            background-color: var(--color-light-gray);
            color: var(--color-white);
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .label-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .label-wrapper label {
            margin-bottom: 0;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <main>
        <h1>–†–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä —Å–ø–∏—Å–∫–æ–≤</h1>

        <div class="centration">
            <div class="tool-description">
                <p class="intro">–≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö
                    –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–∫–ª–∏–∫–∞—Ç—å—Å—è.</p>
                <p class="intro">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–µ –¥–µ–ª–∞–µ—Ç –≤—Å—é —Ä–∞–±–æ—Ç—É –∑–∞ –≤–∞—Å, –∞ –ª–∏—à—å —É—Å–∫–æ—Ä—è–µ—Ç —Ç–∞–º, –≥–¥–µ —É–∂–µ –±—ã–ª–∞ —Å–æ–±—Ä–∞–Ω–∞ –ë–î
                    –∑–∞–ø—Ä–æ—Å–æ–≤. –¢–∞–º, –≥–¥–µ –∏—Ö –Ω–µ—Ç - –≤—ã –¥–æ–ª–∂–Ω—ã —Å–æ–±–∏—Ä–∞—Ç—å –∏—Ö —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ. –í—ã —Ç–∞–∫ –∂–µ –º–æ–∂–µ—Ç–µ –¥–æ–ø–æ–ª–Ω—è—Ç—å –ë–î
                    –∑–∞–ø—Ä–æ—Å–æ–≤, –¥–ª—è –æ–±–ª–µ–≥—á–µ–Ω–∏—è —Å–≤–æ–µ–π —Ä–∞–±–æ—Ç—ã –∏ —Ä–∞–±–æ—Ç—ã –∫–æ–ª–ª–µ–≥ –≤ –±—É–¥—É—â–µ–º.</p>
            </div>

            <div class="controls-container">

                <!-- –ë–ª–æ–∫ —Å—Ç–∞—Ç—É—Å–∞ Firebase -->
                <div class="firebase-status">
                    <div>
                        <h3 style="margin: 0 0 5px 0; font-size: 1.1rem; color: var(--color-blue-text);">–û–±–ª–∞—á–Ω–∞—è
                            –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
                        <p id="connection-status" style="margin: 0; font-size: 0.9rem; color: #555;">üü°
                            –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
                    </div>

                </div>

                <!-- 1. –í—ã–±–æ—Ä —Ä–∞–∑–¥–µ–ª–∞ -->
                <div class="control-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:</label>
                    <div class="custom-dropdown" id="custom-parent-select">
                        <div class="select-selected">
                            <span id="selected-parent-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            <div class="select-arrow"></div>
                        </div>
                        <div class="select-items select-hide" id="parent-options-container">
                            <!-- JS -->
                        </div>
                    </div>
                </div>

                <!-- 2. –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                <div class="control-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</label>
                    <div class="custom-dropdown" id="custom-child-select">
                        <div class="select-selected disabled">
                            <span id="selected-category-text">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</span>
                            <div class="select-arrow"></div>
                        </div>
                        <div class="select-items select-hide">
                            <input type="text" placeholder="–ü–æ–∏—Å–∫..." id="category-search-input" autocomplete="off">
                            <div id="category-options-container">
                                <!-- JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                <div class="control-group">
                    <label for="results-count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤:</label>
                    <input type="number" id="results-count" class="custom-input" value="5" min="1">
                </div>

                <div class="control-group">
                    <div class="label-wrapper">
                        <label for="toponym-input">–¢–æ–ø–æ–Ω–∏–º –¥–ª—è –∑–∞–º–µ–Ω—ã:</label>
                        <button id="info-btn" class="info-icon-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É">?</button>
                    </div>
                    <input type="text" id="toponym-input" class="custom-input" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–ª–∞–¥–∏–∫–∞–≤–∫–∞–∑">
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div class="button-group">
                    <button id="add-data-modal-btn" class="btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                    <button id="randomize-btn" class="btn">–†–∞–Ω–¥–æ–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button id="copy-btn" class="btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
            <div id="result-container" class="result-container">
                <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h2>
                <ul id="result-list"></ul>
            </div>
        </div>
    </main>

    <footer class="footer_container">
        <p class="footer_copyright">&copy; 2026, Yatvig. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
    </footer>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ -->
    <div id="add-data-modal" class="modal-overlay">
        <div class="modal-content" style="text-align: left;">
            <button class="modal-close-btn" id="close-add-modal">&times;</button>
            <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</h3>

            <div class="control-group">
                <label>–†–∞–∑–¥–µ–ª (–†–æ–¥–∏—Ç–µ–ª—å):</label>
                <input type="text" id="new-parent-input" class="custom-input" list="parent-list-hints"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö—É–ª–∏–Ω–∞—Ä–∏—è" autocomplete="off">
                <datalist id="parent-list-hints"></datalist>
            </div>

            <div class="control-group">
                <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–†–µ–±–µ–Ω–æ–∫):</label>
                <input type="text" id="new-child-input" class="custom-input" list="child-list-hints"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—É–ø—ã" autocomplete="off">
                <datalist id="child-list-hints"></datalist>
            </div>

            <div class="control-group">
                <label>–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:</label>
                <input type="text" id="new-query-input" class="custom-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–∞–∫ –≤–∞—Ä–∏—Ç—å –±–æ—Ä—â">
            </div>

            <div class="control-group">
                <label>–ß–∞—Å—Ç–æ—Ç–Ω–æ—Å—Ç—å:</label>
                <input type="number" id="new-freq-input" class="custom-input" value="100">
            </div>

            <button class="btn" id="save-new-data-btn" style="width: 100%; margin-top: 10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤
                –æ–±–ª–∞–∫–æ</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ò–Ω—Ñ–æ -->
    <div id="info-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn modal-close-trigger">&times;</button>
            <h3>–ü–æ–¥—Å–∫–∞–∑–∫–∞</h3>
            <p>–í–≤–µ–¥–∏—Ç–µ —Ç–æ–ø–æ–Ω–∏–º –¥–ª—è –∑–∞–º–µ–Ω—ã "–ú–æ—Å–∫–≤—ã".</p>
            <button class="btn modal-close-trigger">–ü–æ–Ω—è—Ç–Ω–æ</button>
        </div>
    </div>

    <!-- –°–∫—Ä–∏–ø—Ç -->
    <script type="module">
        // 1. –ò–ú–ü–û–†–¢ –§–£–ù–ö–¶–ò–ô FIREBASE (–ò—Å–ø–æ–ª—å–∑—É–µ–º CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // 2. –ù–ê–°–¢–†–û–ô–ö–ò (–í–°–¢–ê–í–¨ –°–í–û–ô –ö–û–î –ù–ò–ñ–ï)
        // ==========================================

        // –í—Å—Ç–∞–≤—å —Å—é–¥–∞ const firebaseConfig = { ... }, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª —Å —Å–∞–π—Ç–∞ Firebase
        // –ï—Å–ª–∏ —Ç—ã –ø–æ—Ç–µ—Ä—è–ª –∫–æ–¥, –∑–∞–π–¥–∏ –≤ Project Settings -> General -> Your apps

        const firebaseConfig = {
            apiKey: "AIzaSyCxEBDlOBK2QwduPO1S5ri9DpRBnoMhtt8",
            authDomain: "yatvig-a0214.firebaseapp.com",
            projectId: "yatvig-a0214",
            storageBucket: "yatvig-a0214.firebasestorage.app",
            messagingSenderId: "1049548595731",
            appId: "1:1049548595731:web:7fc9ca611648fc31ead5e6"
        };


        // ==========================================
        // 3. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ==========================================

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫—É –≤—Å—Ç–∞–≤–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞
        if (!firebaseConfig.apiKey) {
            alert("–û—à–∏–±–∫–∞! –í—ã –Ω–µ –≤—Å—Ç–∞–≤–∏–ª–∏ firebaseConfig –≤ –∫–æ–¥ —Å–∫—Ä–∏–ø—Ç–∞. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á–∏.");
            throw new Error("Config missing");
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // –ò–º—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–ø–∞–ø–∫–∞, –≥–¥–µ –ª–µ–∂–∞—Ç —Ä–∞–∑–¥–µ–ª—ã)
        const COLLECTION_NAME = "search_sections";

        // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å –æ–±–ª–∞–∫–æ–º)
        let globalData = {};

        // --- –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ---
        const connectionStatus = document.getElementById('connection-status');

        // –°–µ–ª–µ–∫—Ç—ã
        const parentSelect = document.getElementById('custom-parent-select');
        const parentSelectedText = document.getElementById('selected-parent-text');
        const parentOptionsContainer = document.getElementById('parent-options-container');

        const childSelect = document.getElementById('custom-child-select');
        const childSelectedText = document.getElementById('selected-category-text');
        const childOptionsContainer = document.getElementById('category-options-container');
        const searchInput = document.getElementById('category-search-input');

        // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã
        const resultsCountInput = document.getElementById('results-count');
        const toponymInput = document.getElementById('toponym-input');
        const randomizeBtn = document.getElementById('randomize-btn');
        const copyBtn = document.getElementById('copy-btn');
        const resultList = document.getElementById('result-list');

        // –ú–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        const addModal = document.getElementById('add-data-modal');
        const addBtn = document.getElementById('add-data-modal-btn');
        const closeAddBtns = document.querySelectorAll('#close-add-modal');
        const saveNewDataBtn = document.getElementById('save-new-data-btn');

        const newParentInput = document.getElementById('new-parent-input');
        const newChildInput = document.getElementById('new-child-input');
        const newQueryInput = document.getElementById('new-query-input');
        const newFreqInput = document.getElementById('new-freq-input');
        const parentHints = document.getElementById('parent-list-hints');
        const childHints = document.getElementById('child-list-hints');

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±–æ—Ä–∞
        let currentParentValue = '';
        let currentChildValue = '';
        let currentListData = [];
        const originalCopyBtnText = copyBtn.textContent;


        // ==========================================
        // 4. –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ë–ê–ó–ï (REAL-TIME LISTENER)
        // ==========================================

        // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–∞–º–∞ –∏ —Å–ª—É—à–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ
        onSnapshot(collection(db, COLLECTION_NAME), (snapshot) => {
            // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
            const newData = {};
            let isEmpty = true;

            snapshot.forEach((doc) => {
                // doc.id = –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ö—É–ª–∏–Ω–∞—Ä–∏—è")
                // doc.data() = –û–±—ä–µ–∫—Ç —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, { "–°—É–ø—ã": [...] })
                newData[doc.id] = doc.data();
                isEmpty = false;
            });

            globalData = newData;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            connectionStatus.textContent = `üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ. –†–∞–∑–¥–µ–ª–æ–≤: ${Object.keys(globalData).length}`;
            connectionStatus.style.color = 'green';

            // –ï—Å–ª–∏ –±–∞–∑–∞ –ø—É—Å—Ç–∞—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–ª–∏–≤–∫–∏ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö
            if (isEmpty) {
                parentSelectedText.textContent = "–ë–∞–∑–∞ –ø—É—Å—Ç–∞";
            } else {
                // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –º–µ–Ω—é
                refreshUI();
            }
        }, (error) => {
            console.error("–û—à–∏–±–∫–∞ Firebase:", error);
            connectionStatus.textContent = `üî¥ –û—à–∏–±–∫–∞: ${error.message}`;
            connectionStatus.style.color = 'red';
        });


        // ==========================================
        // 5. –õ–û–ì–ò–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê
        // ==========================================

        function refreshUI() {
            renderParentOptions();
            updateHints();

            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–Ω–µ–µ —Ä–∞–∑–¥–µ–ª –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            if (currentParentValue && globalData[currentParentValue]) {
                renderChildOptions(currentParentValue);
                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                if (currentChildValue && globalData[currentParentValue][currentChildValue]) {
                    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –Ω–µ –¥–µ–ª–∞—Ç—å –∞–≤—Ç–æ-—Ä–∞–Ω–¥–æ–º, —á—Ç–æ–±—ã –Ω–µ —Å–±–∏–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                }
            } else {
                // –°–±—Ä–æ—Å, –µ—Å–ª–∏ —Ä–∞–∑–¥–µ–ª —É–¥–∞–ª–∏–ª–∏
                parentSelectedText.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª";
                currentParentValue = '';
            }
        }

        function updateHints() {
            parentHints.innerHTML = '';
            childHints.innerHTML = '';
            Object.keys(globalData).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                parentHints.appendChild(opt);
            });
        }

        newParentInput.addEventListener('input', () => {
            const val = newParentInput.value;
            childHints.innerHTML = '';
            if (globalData[val]) {
                Object.keys(globalData[val]).forEach(childKey => {
                    const opt = document.createElement('option');
                    opt.value = childKey;
                    childHints.appendChild(opt);
                });
            }
        });

        // --- –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–æ–≤ ---

        function renderParentOptions() {
            parentOptionsContainer.innerHTML = '';
            const parentKeys = Object.keys(globalData).sort();

            if (parentKeys.length === 0) return;

            parentKeys.forEach((key) => {
                const div = document.createElement('div');
                div.textContent = key;
                div.className = 'option-item';
                div.addEventListener('click', () => selectParent(key));
                parentOptionsContainer.appendChild(div);
            });
        }

        function selectParent(value, closeMenu = true) {
            currentParentValue = value;
            parentSelectedText.textContent = value;
            if (closeMenu) toggleSelect(parentSelect, false);

            renderChildOptions(value);

            // –°–±—Ä–æ—Å —Ä–µ–±–µ–Ω–∫–∞
            childSelectedText.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é";
            currentChildValue = '';
            childSelect.querySelector('.select-selected').classList.remove('disabled');
        }

        function renderChildOptions(parentKey) {
            childOptionsContainer.innerHTML = '';
            const subCategories = globalData[parentKey];

            if (!subCategories) return;

            const childKeys = Object.keys(subCategories).sort();

            childKeys.forEach((key) => {
                const div = document.createElement('div');
                div.textContent = key;
                div.className = 'option-item';
                div.addEventListener('click', () => selectChild(key));
                childOptionsContainer.appendChild(div);
            });
        }

        function selectChild(value, closeMenu = true) {
            currentChildValue = value;
            childSelectedText.textContent = value;
            if (closeMenu) toggleSelect(childSelect, false);
            searchInput.value = '';
            filterOptions('');
            handleRandomize();
        }

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—à–∫–∞–º–∏ ---
        function toggleSelect(selectElement, forceState) {
            const items = selectElement.querySelector('.select-items');
            const selectedDiv = selectElement.querySelector('.select-selected');

            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —ç—Ç–æ—Ç, –∑–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ
            if (!items.classList.contains('select-hide') === false && forceState !== false) {
                closeAllSelects(selectElement);
            }

            if (forceState !== undefined) {
                if (forceState) {
                    items.classList.remove('select-hide');
                    selectedDiv.classList.add('select-arrow-active');
                } else {
                    items.classList.add('select-hide');
                    selectedDiv.classList.remove('select-arrow-active');
                }
            } else {
                items.classList.toggle('select-hide');
                selectedDiv.classList.toggle('select-arrow-active');
            }
        }

        function closeAllSelects(exceptElement) {
            [parentSelect, childSelect].forEach(sel => {
                if (sel !== exceptElement) {
                    sel.querySelector('.select-items').classList.add('select-hide');
                    sel.querySelector('.select-selected').classList.remove('select-arrow-active');
                }
            });
        }

        parentSelect.querySelector('.select-selected').addEventListener('click', (e) => { e.stopPropagation(); toggleSelect(parentSelect); });
        childSelect.querySelector('.select-selected').addEventListener('click', (e) => {
            if (currentParentValue) {
                e.stopPropagation();
                toggleSelect(childSelect);
                if (!childSelect.querySelector('.select-items').classList.contains('select-hide')) searchInput.focus();
            }
        });
        document.addEventListener('click', () => closeAllSelects(null));
        searchInput.addEventListener('click', (e) => e.stopPropagation());
        searchInput.addEventListener('input', (e) => filterOptions(e.target.value));

        function filterOptions(text) {
            const filter = text.toLowerCase();
            const options = childOptionsContainer.getElementsByClassName('option-item');
            for (let div of options) {
                div.style.display = (div.textContent || div.innerText).toLowerCase().indexOf(filter) > -1 ? "" : "none";
            }
        }


        // ==========================================
        // 6. –†–ê–ù–î–û–ú–ê–ô–ó–ï–† (–õ–û–ì–ò–ö–ê)
        // ==========================================

        function handleRandomize() {
            const resultsCount = parseInt(resultsCountInput.value, 10);
            const toponym = toponymInput.value.trim();

            if (currentParentValue && currentChildValue &&
                globalData[currentParentValue] && globalData[currentParentValue][currentChildValue]) {

                const data = globalData[currentParentValue][currentChildValue];
                let randomized = [...data].sort(() => 0.5 - Math.random()).slice(0, resultsCount);

                if (toponym) {
                    const targets = ["–º–æ—Å–∫–≤–∞", "–º–æ—Å–∫–≤–µ", "–º–æ—Å–∫–≤—ã"];
                    randomized = randomized.map(item => {
                        let q = item.query;
                        targets.forEach(t => {
                            const regex = new RegExp(`(^|[\\s])(${t})(?=$|[\\s.,!?])`, 'gi');
                            q = q.replace(regex, `$1${toponym}`);
                        });
                        return { ...item, query: q };
                    });
                }
                displayResults(randomized);
            } else {
                displayResults([]);
            }
        }

        function displayResults(list) {
            resultList.innerHTML = '';
            currentListData = [];
            if (!list || list.length === 0) {
                resultList.innerHTML = '<li>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</li>';
                copyBtn.disabled = true;
                return;
            }
            list.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${item.query}</span><span class="frequency-span">–ß–∞—Å—Ç–æ—Ç–Ω–æ—Å—Ç—å: ${item.frequency}</span>`;
                resultList.appendChild(li);
                currentListData.push(item.query);
            });
            copyBtn.disabled = false;
        }

        randomizeBtn.addEventListener('click', handleRandomize);
        copyBtn.addEventListener('click', () => {
            if (copyBtn.disabled || currentListData.length === 0) return;
            navigator.clipboard.writeText(currentListData.join('\n')).then(() => {
                const t = copyBtn.textContent;
                copyBtn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                copyBtn.disabled = true;
                setTimeout(() => { copyBtn.textContent = t; copyBtn.disabled = false; }, 2000);
            });
        });


        // ==========================================
        // 7. –î–û–ë–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–• –í –û–ë–õ–ê–ö–û
        // ==========================================

        addBtn.addEventListener('click', () => {
            addModal.classList.add('active');
            updateHints(); // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º
        });

        closeAddBtns.forEach(b => b.addEventListener('click', () => addModal.classList.remove('active')));

        saveNewDataBtn.addEventListener('click', async () => {
            const p = newParentInput.value.trim();
            const c = newChildInput.value.trim();
            const q = newQueryInput.value.trim();
            const f = parseInt(newFreqInput.value, 10);

            if (!p || !c || !q) { alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!'); return; }

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const originalBtnText = saveNewDataBtn.textContent;
            saveNewDataBtn.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
            saveNewDataBtn.disabled = true;

            try {
                // 1. –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç –†–∞–∑–¥–µ–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ö—É–ª–∏–Ω–∞—Ä–∏—è")
                const sectionRef = doc(db, COLLECTION_NAME, p);

                // 2. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
                const docSnap = await getDoc(sectionRef);

                let currentSectionData = {};
                if (docSnap.exists()) {
                    currentSectionData = docSnap.data();
                }

                // 3. –°–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                if (!currentSectionData[c]) {
                    currentSectionData[c] = [];
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
                const exists = currentSectionData[c].some(item => item.query === q);
                if (exists) {
                    alert("–¢–∞–∫–æ–π –∑–∞–ø—Ä–æ—Å —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ!");
                    saveNewDataBtn.textContent = originalBtnText;
                    saveNewDataBtn.disabled = false;
                    return;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º
                currentSectionData[c].push({ query: q, frequency: f || 0 });

                // 4. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ Firebase
                // setDoc —Å merge: true —Å–æ–∑–¥–∞—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç, –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
                await setDoc(sectionRef, currentSectionData, { merge: true });

                // –£—Å–ø–µ—Ö
                newQueryInput.value = ''; // –ß–∏—Å—Ç–∏–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                alert(`‚úÖ –ó–∞–ø—Ä–æ—Å "${q}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –æ–±–ª–∞–∫–æ!`);

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                saveNewDataBtn.textContent = originalBtnText;
                saveNewDataBtn.disabled = false;

                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–µ–ª–µ–∫—Ç—ã –Ω–∞ —Ç–æ, —á—Ç–æ –¥–æ–±–∞–≤–∏–ª–∏ (—á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª)
                currentParentValue = p;
                currentChildValue = c;
                // –¢–∞–∫ –∫–∞–∫ onSnapshot —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, UI –æ–±–Ω–æ–≤–∏—Ç—Å—è —Å–∞–º, 
                // –Ω–∞–º –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å —á—É—Ç—å-—á—É—Ç—å –∏–ª–∏ –≤—Ä—É—á–Ω—É—é –≤—ã–±—Ä–∞—Ç—å –≤ –º–µ–Ω—é –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: " + e.message);
                saveNewDataBtn.textContent = originalBtnText;
                saveNewDataBtn.disabled = false;
            }
        });





        // –ú–æ–¥–∞–ª–∫–∞ –∏–Ω—Ñ–æ
        const infoBtn = document.getElementById('info-btn');
        const infoModal = document.getElementById('info-modal');
        if (infoBtn) infoBtn.addEventListener('click', () => infoModal.classList.add('active'));
        document.querySelectorAll('.modal-close-trigger').forEach(b => b.addEventListener('click', () => infoModal.classList.remove('active')));

    </script>
</body>

</html>